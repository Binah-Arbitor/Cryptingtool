name: Build Debug APK

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to use'
        required: false
        default: '3.24.5'
        type: string

jobs:
  build-debug-apk:
    name: Build Debug APK
    runs-on: ubuntu-22.04  # Latest LTS Ubuntu for maximum stability and performance
    timeout-minutes: 45    # Reasonable timeout for APK builds
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Shallow clone for faster checkout
      
    - name: Setup Java 17 JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'  # Eclipse Temurin - most stable OpenJDK distribution
        java-version: '17'
        cache: gradle
        
    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ github.event.inputs.flutter_version || '3.24.5' }}  # Latest stable
        channel: 'stable'
        cache: true
        cache-key: "flutter-${{ github.event.inputs.flutter_version || '3.24.5' }}-stable"
        cache-path: ${{ runner.tool_cache }}/flutter
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'  # Command line tools version 12.0 (long format)
        accept-android-sdk-licenses: true
        log-accepted-android-sdk-licenses: false
        packages: 'platforms;android-32 platforms;android-33 platforms;android-34 platforms;android-35 build-tools;34.0.0 build-tools;35.0.0 ndk;26.1.10909125 cmake;3.22.1 platform-tools'
        
    - name: Accept Android Licenses (Enhanced)
      run: |
        echo "ðŸ“ Accepting Android SDK licenses with enhanced method..."
        # Method 1: Standard acceptance with timeout
        timeout 120 bash -c 'yes | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses' || echo "âš ï¸ Method 1 timed out"
        
        # Method 2: Fallback with specific license acceptance (Stack Overflow solution)
        echo "ðŸ”„ Fallback license acceptance method..."
        for i in {1..3}; do
          echo "Attempt $i/3"
          if timeout 60 bash -c 'echo -e "y\ny\ny\ny\ny\ny\ny\ny\ny\ny" | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses'; then
            echo "âœ… Licenses accepted successfully"
            break
          else
            echo "âš ï¸ Attempt $i failed, retrying..."
            sleep 2
          fi
        done
        
        # Verify license status
        echo "ðŸ” Verifying license acceptance status..."
        ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses | head -20 || echo "License check completed"
        
    - name: Install C++ Dependencies
      run: |
        echo "ðŸ”§ Installing C++ build dependencies and Crypto++ library..."
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libcrypto++-dev \
          libcrypto++-utils \
          cmake \
          ninja-build \
          pkg-config \
          build-essential \
          libc6-dev
          
    - name: Verify C++ Dependencies (Optimized)
      run: |
        echo "ðŸ” Quick verification of C++ dependencies..."
        # Fast verification using pkg-config (no filesystem scanning)
        if pkg-config --exists libcrypto++; then
          echo "âœ… Crypto++ found via pkg-config: $(pkg-config --modversion libcrypto++)"
        else
          echo "âš ï¸ pkg-config verification failed"
        fi
        
        # Quick library existence check (specific path, no find command)
        if [ -f "/usr/lib/x86_64-linux-gnu/libcryptopp.so" ]; then
          echo "âœ… Crypto++ library available"
        else
          echo "âš ï¸ Standard library path not found"
        fi
        
    - name: Flutter Dependencies & Doctor
      run: |
        echo "ðŸ“± Installing Flutter dependencies and checking environment..."
        flutter pub get
        echo "Flutter version:"
        flutter --version
        echo "Flutter doctor output:"
        flutter doctor -v
        
    - name: Build C++ Components
      run: |
        echo "ðŸ”¨ Building native C++ cryptographic components..."
        mkdir -p cmake_build
        cd cmake_build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -G Ninja \
          -DCMAKE_VERBOSE_MAKEFILE=ON
        ninja -v
        cd ..
        echo "âœ… C++ components built successfully"
        
    - name: Configure Android Build Environment
      run: |
        echo "âš™ï¸ Configuring Android build environment..."
        # Create local.properties file for Android build
        cat > android/local.properties << EOF
        flutter.sdk=${FLUTTER_ROOT}
        sdk.dir=${ANDROID_SDK_ROOT}
        ndk.dir=${ANDROID_SDK_ROOT}/ndk/26.1.10909125
        EOF
        
        echo "ðŸ“‹ Android build configuration:"
        cat android/local.properties
        
    - name: Build Debug APK
      run: |
        echo "ðŸ—ï¸ Building debug APK with multi-architecture support..."
        flutter build apk \
          --debug \
          --target-platform android-arm,android-arm64,android-x64 \
          --split-per-abi \
          --verbose
        echo "âœ… APK build completed successfully"
          
    - name: Verify APK Build Results
      run: |
        echo "ðŸ” Verifying APK build results..."
        # List all generated APK files
        echo "ðŸ“± Generated APK files:"
        find build/app/outputs/flutter-apk/ -name "*.apk" -type f | sort
        
        echo "ðŸ“Š APK files summary:"
        ls -lah build/app/outputs/flutter-apk/
        
        # Analyze each APK
        echo "ðŸ”¬ APK Analysis:"
        for apk in build/app/outputs/flutter-apk/app-*-debug.apk build/app/outputs/flutter-apk/app-debug.apk; do
          if [ -f "$apk" ]; then
            echo "===================="
            echo "ðŸ“± APK: $(basename $apk)"
            echo "ðŸ’¾ Size: $(du -h "$apk" | cut -f1)"
            echo "ðŸ“‹ Info:"
            ${ANDROID_SDK_ROOT}/build-tools/34.0.0/aapt dump badging "$apk" | grep -E "(package|sdkVersion|targetSdkVersion|application-label)" | head -10
            echo ""
          fi
        done
        
    - name: Upload Debug APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-${{ github.sha }}
        path: |
          build/app/outputs/flutter-apk/app-*-debug.apk
          build/app/outputs/flutter-apk/app-debug.apk
        if-no-files-found: error
        retention-days: 30
        compression-level: 6  # Balanced compression
        
    - name: Upload Build Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          cmake_build/
          build/
          android/app/build/
          ~/.gradle/caches/
        retention-days: 7