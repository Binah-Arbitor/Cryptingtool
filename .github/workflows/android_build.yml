name: Flutter Android Build

on:
  push:
    branches: [ "main" ] # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [ "main" ] # main ë¸Œëœì¹˜ë¡œ pull requestê°€ ì˜¬ ë•Œ ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest # ë¹Œë“œë¥¼ ì‹¤í–‰í•  í™˜ê²½

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. JDK(Java Development Kit) ì„¤ì¹˜ (Gradle ì‹¤í–‰ì— í•„ìš”)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # í”„ë¡œì íŠ¸ì˜ build.gradleê³¼ í˜¸í™˜ë˜ëŠ” ë²„ì „ìœ¼ë¡œ ì„¤ì •

    # 3. Flutter SDK ì„¤ì¹˜ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„) - ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3' # filePermissions ì´ìŠˆê°€ í•´ê²°ëœ ìµœì‹  ë²„ì „
        channel: 'stable'

    # 4. Android SDK ì„¤ì • ë° ë¼ì´ì„¼ìŠ¤ ë™ì˜
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 5. Android SDK ë¼ì´ì„¼ìŠ¤ ìë™ ë™ì˜
    - name: Accept Android SDK licenses
      run: yes | flutter doctor --android-licenses || echo "Some licenses may already be accepted"

    # 6. C++ ì»´íŒŒì¼ëŸ¬ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (C++ í†µí•©ì„ ìœ„í•´)
    - name: Install C++ dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build libcrypto++-dev

    # 7. Flutter íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ - ìºì‹œ í´ë¦¬ì–´ í¬í•¨
    - name: Clean and get Flutter packages
      run: |
        flutter clean
        flutter pub get

    # 8. Flutter ë‹¥í„° ì‹¤í–‰ (ì„¤ì • í™•ì¸)
    - name: Flutter doctor
      run: flutter doctor -v

    # 9. Gradle ìºì‹œ í´ë¦¬ì–´ ë° Wrapper ìƒì„±
    - name: Clean Gradle cache and Generate Gradle Wrapper
      run: |
        # Gradle ìºì‹œ í´ë¦¬ì–´
        rm -rf ~/.gradle/caches/
        cd android
        # ê¸°ì¡´ ë¹Œë“œ ìºì‹œ ì œê±°
        rm -rf build/ app/build/ .gradle/
        if [ ! -f "gradlew" ]; then
          echo "Gradle wrapper not found, generating..."
          gradle wrapper --gradle-version=8.4
        fi

    # 10. Flutter ë¹Œë“œ ëª…ë ¹ì–´ ì‹¤í–‰ (APK ìƒì„±)
    # ì´ ëª…ë ¹ì–´ê°€ Dart ì»´íŒŒì¼ê³¼ C++ NDK ë¹Œë“œë¥¼ í¬í•¨í•œ ëª¨ë“  ê²ƒì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    - name: Build APK
      run: flutter build apk --debug

    # 11. ë¹Œë“œëœ APK íŒŒì¼ì„ Artifactë¡œ ì—…ë¡œë“œ (ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œìš©)
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk

    # 12. ë¹Œë“œ ì •ë³´ ìš”ì•½ ì¶œë ¥
    - name: Build summary
      run: |
        echo "âœ… APK ë¹Œë“œ ì™„ë£Œ!"
        echo "ğŸ“± ì•± ì´ë¦„: CryptingTool"
        echo "ğŸ”§ ë¹Œë“œ íƒ€ì…: Debug"
        echo "ğŸ“Š APK ìœ„ì¹˜: build/app/outputs/flutter-apk/app-debug.apk"
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          echo "ğŸ“ APK í¬ê¸°: $(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)"
        fi